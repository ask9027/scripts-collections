#!/data/data/com.termux/files/usr/bin/bash
set -Eeuo pipefail

#######################################
# ROOT RE-EXEC (-r anywhere)
#######################################
if [ "$(id -u)" -ne 0 ]; then
    for arg in "$@"; do
        if [ "$arg" = "-r" ] || [ "$arg" = "--root" ]; then
            new_args=()
            for a in "$@"; do
                [[ "$a" != "-r" && "$a" != "--root" ]] && new_args+=("$a")
            done
            exec su -c "\"$0\" ${new_args[*]}"
        fi
    done
fi

#######################################
# LOGGING SYSTEM
#######################################
: "${TMX_EMOJI:=1}"

if [ -t 1 ] && [ -z "${NO_COLOR:-}" ]; then
    COLOR=1
else
    COLOR=0
fi

# ---- FIXED: real ANSI escape sequences ----
if [ "$COLOR" -eq 1 ]; then
    RED=$'\033[31m'
    GREEN=$'\033[32m'
    YELLOW=$'\033[33m'
    BLUE=$'\033[34m'
    CYAN=$'\033[36m'
    MAGENTA=$'\033[35m'
    BOLD=$'\033[1m'
    DIM=$'\033[2m'
    RESET=$'\033[0m'
else
    RED= GREEN= YELLOW= BLUE= CYAN= MAGENTA= BOLD= DIM= RESET=
fi

if [ "$TMX_EMOJI" -eq 1 ]; then
    E_INFO="ℹ"
    E_OK="✓"
    E_WARN="!"
    E_ERR="✗"
    E_ACT="→"
else
    E_INFO="INFO"
    E_OK="OK"
    E_WARN="WARN"
    E_ERR="ERROR"
    E_ACT="ACTION"
fi

_ts() { date +"%H:%M:%S"; }

log_info()   { printf "${DIM}%s${RESET} ${BLUE}[%s]${RESET} %s\n" "$(_ts)" "$E_INFO" "$*"; }
log_ok()     { printf "${DIM}%s${RESET} ${GREEN}[%s]${RESET} %s\n" "$(_ts)" "$E_OK" "$*"; }
log_warn()   { printf "${DIM}%s${RESET} ${YELLOW}[%s]${RESET} %s\n" "$(_ts)" "$E_WARN" "$*"; }
log_err()    { printf "${DIM}%s${RESET} ${RED}[%s]${RESET} %s\n" "$(_ts)" "$E_ERR" "$*"; }
log_action() { printf "${DIM}%s${RESET} ${BOLD}${CYAN}[%s]${RESET} %s\n" "$(_ts)" "$E_ACT" "$*"; }
log_ctx()    { printf "${DIM}%s${RESET} ${MAGENTA}[%s]${RESET} %s\n" "$(_ts)" "$1" "$2"; }

#######################################
# SECURITY-AWARE SELINUX LOGGING
#######################################
log_selinux_state() {
    case "$1" in
        Enforcing)
            log_ok "SELinux state: ${BOLD}${GREEN}Enforcing${RESET} (secure)"
            ;;
        Permissive)
            log_err "SELinux state: ${BOLD}${RED}Permissive${RESET} (SECURITY RISK)"
            ;;
        *)
            log_warn "SELinux state: $1"
            ;;
    esac
}

#######################################
# GLOBALS (UNCHANGED LOGIC)
#######################################
ROOT_MODE=$(id -u)
extra=""
server_pid=""
export XKB_CONFIG_ROOT="/data/data/com.termux/files/usr/share/xkeyboard-config-2/"

#######################################
# SIGNAL HANDLING
#######################################
_CLEANED_UP=0
cleanup() {
    if [ "$_CLEANED_UP" -eq 1 ]; then
        return
    fi
    _CLEANED_UP=1
    echo
    log_warn "Stopping Termux-X11"
    TMP="${TMPDIR:-$PREFIX/tmp}"
    rm -rf ${TMP}/.X* || true

    if [ "$ROOT_MODE" -eq 0 ]; then
        setenforce 1 || true
        log_ok "SELinux restored → ${BOLD}${GREEN}Enforcing${RESET} (secure)"
    else
        if pgrep pulseaudio >/dev/null; then
            log_warn "Stopping PulseAudio"
            pulseaudio -k || true
        fi
    fi

    log_ok "Exit complete"
    exit 0
}

trap cleanup INT TERM EXIT

#######################################
# CHECK RUNNING SERVER (UNCHANGED)
#######################################
check_server() {
    if [ "$ROOT_MODE" -eq 0 ]; then
        server_pid=$(pidof com.termux-x11 || true)
    else
        server_pid=$(pgrep com.termux-x11 || true)
    fi

    if [ -n "$server_pid" ]; then
        log_err "XServer already running (PID: $server_pid)"
        log_info "Stop with: kill $server_pid"
        exit 0
    fi

    log_ok "No running XServer detected"
}

#######################################
# AUDIO (UNCHANGED LOGIC)
#######################################
setup_audio() {
    command -v pulseaudio >/dev/null || {
        log_action "Installing PulseAudio"
        apt update && apt install pulseaudio -y
    }
}

start_audio() {
    setup_audio
    pgrep pulseaudio >/dev/null && pulseaudio -k || true
    log_action "Starting PulseAudio"
    pulseaudio --start \
        --load="module-native-protocol-tcp auth-ip-acl=127.0.0.1 auth-anonymous=1" \
        --exit-idle-time=-1 -D
}

#######################################
# HELP (UNCHANGED)
#######################################
show_help() {
    printf "${BOLD}tmx${RESET} — Termux-X11 launcher\n\n"
    printf "${BOLD}Usage:${RESET}\n"
    printf "  tmx [options]\n\n"
    printf "${BOLD}Options:${RESET}\n"
    printf "  ${CYAN}-r, --root${RESET}       Run X11 as root (SELinux → permissive)\n"
    printf "  ${CYAN}-d, --debug${RESET}      Enable verbose Termux-X11 logging\n"
    printf "  ${CYAN}-s, --sound${RESET}      Enable PulseAudio (user mode only)\n"
    printf "  ${CYAN}-x, --xserver${RESET}    Pass options to X server\n"
    printf "  ${CYAN}-c, --chroot DIR${RESET} Use XKB data from chroot\n"
    printf "  ${CYAN}-h, --help${RESET}       Show this help\n"
}

#######################################
# ARGUMENT HANDLING (ONLY INVALID FIXED)
#######################################
while [ $# -gt 0 ]; do
    case "$1" in
        -h|--help)
            show_help
            exit 0
            ;;
        -d|--debug)
            export TERMUX_X11_DEBUG=1
            log_info "Debug enabled"
            ;;
        -s|--sound)
            if [ "$ROOT_MODE" -eq 0 ]; then
                log_warn "Audio not supported in root"
            else
                start_audio
            fi
            ;;
        -c|--chroot)
            shift
            export XKB_CONFIG_ROOT="$1/usr/share/X11/xkb"
            log_info "Chroot XKB path set"
            ;;
        -x|--xserver)
            shift
            extra="$1"
            log_info "XServer options: $extra"
            ;;
        *)
            log_err "Invalid option: $1"
            show_help
            exit 1
            ;;
    esac
    shift
done

#######################################
# START X11 (CORE LOGIC PRESERVED)
#######################################
setup() {
    local loader="/data/data/com.termux/files/usr/libexec/termux-x11/loader.apk"

    if ! command -v termux-x11 &>/dev/null; then
        log_action "Installing Termux-X11"
        apt update && apt install termux-x11-* -y
    fi

    export CLASSPATH="$loader"
    unset LD_LIBRARY_PATH LD_PRELOAD

    /system/bin/app_process -Xnoimage-dex2oat / \
        --nice-name="com.termux-x11" \
        com.termux.x11.Loader $extra
}

setup_root() {
    current_state="$(getenforce)"
    log_selinux_state "$current_state"

    setenforce 0
    log_err "SELinux changed → ${BOLD}${RED}Permissive${RESET} (SECURITY REDUCED)"

    export CLASSPATH="$(pm path com.termux.x11 | cut -d: -f2)"

    /system/bin/app_process -Xnoimage-dex2oat / \
        --nice-name="com.termux-x11" \
        com.termux.x11.CmdEntryPoint $extra
}

startX11() {
    log_action "Starting Termux-X11"
    log_info "Clearing logcat"
    logcat -c || true

    if [ "$ROOT_MODE" -eq 0 ]; then
        log_ctx "ROOT" "Launching X11 with elevated privileges"
        setup_root
    else
        log_ctx "USER" "Launching X11 in user mode"
        setup
    fi
}

#######################################
# MAIN
#######################################
check_server
startX11
