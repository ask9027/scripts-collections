name: Build gen_snapshot (Linux ARM64)

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build-arm64:
    name: Build gen_snapshot for Linux ARM64
    runs-on: ubuntu-latest

    steps:
      - name: Checkout flutter monorepo
        uses: actions/checkout@v4
        with:
          repository: flutter/flutter
          path: flutter

      - name: Install Required Packages
        run: |
          sudo apt-get update --allow-releaseinfo-change
          sudo apt-get install -y \
          clang ninja-build cmake python3 wget curl unzip \
          g++-aarch64-linux-gnu build-essential pkg-config qemu-user

      - name: Clone depot_tools
        run: |
          git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git ~/depot_tools
          echo 'export PATH="$PATH:$HOME/depot_tools"' >> $GITHUB_ENV

      - name: Setup gclient & sync engine dependencies
        run: |
          source $GITHUB_ENV
          cd flutter
          # Use the standard gclient config for flutter monorepo
          cp engine/scripts/standard.gclient .gclient
          gclient sync --with_branch_heads

      - name: Generate Build Config (GN)
        run: |
          source $GITHUB_ENV
          cd flutter/engine
          ./flutter/tools/gn \
            --target-os=linux \
            --linux-cpu=arm64 \
            --runtime-mode=release \
            --no-goma

      - name: Build gen_snapshot
        run: |
          cd flutter/engine/out/linux_release_arm64
          ninja gen_snapshot

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: gen_snapshot-linux-arm64
          path: |
            flutter/engine/out/linux_release_arm64/gen_snapshot
