name: Build gen_snapshot with Docker

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Create Dockerfile.gen_snapshot
      run: |
        cat << 'EOF' > Dockerfile.gen_snapshot
        # Base image
        FROM ubuntu:22.04
        
        ENV DEBIAN_FRONTEND=noninteractive
        ENV PATH="/depot_tools:${PATH}"
        
        # Install build dependencies
        RUN apt-get update && apt-get install -y \
            build-essential clang python3-dev git curl zip unzip \
            ninja-build pkg-config libglib2.0-dev libgtk-3-dev \
            libc6-dev-arm64-cross gcc-aarch64-linux-gnu g++-aarch64-linux-gnu \
            ca-certificates python3-pip && \
            rm -rf /var/lib/apt/lists/*
        
        RUN pip3 install --upgrade setuptools wheel
        
        # Install depot_tools
        RUN git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git /depot_tools
        
        # Clone Flutter monorepo (shallow)
        RUN git clone --depth 1 https://github.com/flutter/flutter.git /flutter
        
        # Minimal gclient for engine-only dependencies
        RUN cd /flutter && \
            echo 'solutions = [{"name": "engine","url": "https://github.com/flutter/flutter.git","managed": False,"custom_deps": {}}]' > .gclient && \
            # Skip Android SDK/NDK, Dart SDK CIPD downloads
            gclient sync --no-history --shallow --with_branch_heads --nohooks
        
        # Build gen_snapshot for Linux ARM64 host
        RUN cd /flutter/engine/src && \
            ./flutter/tools/gn --runtime-mode=release --linux --linux-cpu=arm64 --no-android && \
            ninja -C out/host_release/gen_snapshot
        
        WORKDIR /flutter/engine/src/out/host_release
        CMD ["/bin/bash"]
        EOF

    - name: Build Docker Image
      run: docker build -t gen_snapshot_builder -f Dockerfile.gen_snapshot .

    - name: Extract gen_snapshot
      run: |
        docker create --name tmp gen_snapshot_builder
        mkdir -p artifact
        docker cp tmp:/flutter/src/out/host_release/gen_snapshot artifact/gen_snapshot_arm64
        docker rm tmp

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: gen_snapshot-arm64
        path: artifact/gen_snapshot_arm64
